<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.joyqueue.repository.MigrationReportRepository">

	<resultMap id="baseResultMap" type="MigrationReport">
		<result property="id" column="id" jdbcType="BIGINT"/>
		<result property="migrationId" column="migration_id" jdbcType="BIGINT"/>
		<result property="type" column="type" jdbcType="VARCHAR"/>
		<result property="topicCode" column="topic_code" jdbcType="VARCHAR"/>
		<result property="namespaceCode" column="namespace_code" jdbcType="VARCHAR"/>
		<result property="pgNo" column="pg_no" jdbcType="TINYINT"/>
		<result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
		<result property="createBy.id" column="create_by" jdbcType="BIGINT"/>
		<result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
		<result property="updateBy.id" column="update_by" jdbcType="BIGINT"/>
		<result property="status" column="status" jdbcType="TINYINT"/>
	</resultMap>

    <insert id="add" useGeneratedKeys="true" keyProperty="id" parameterType="MigrationReport">
       <![CDATA[
          INSERT INTO migration_report(
            `type`,
            migration_id,
            topic_code,
            namespace_code,
            pg_no,
            `create_time`,
            create_by,
            update_time,
            update_by,
            status
            )
          VALUES(
            #{type},
            #{migrationId},
            #{topicCode},
            #{namespaceCode},
            #{pgNo},
            #{createTime},
            #{createBy.id},
            #{updateTime},
            #{updateBy.id},
            #{status}
            )
       ]]>
	</insert>

    <update id="update" parameterType="MigrationReport">
	 <![CDATA[
        UPDATE
            migration_report
        SET
        	migration_id = #{migrationId},
           `type` = #{type},
            topic_code = #{topicCode},
            namespace_code = #{namespaceCode},
            pg_no = #{pgNo},
            `update_by`=#{updateBy.id},
            `update_time`=#{updateTime}
        WHERE
            id=#{id}
        ]]>
	</update>

    <update id="delete" parameterType="MigrationReport">
    <![CDATA[
        UPDATE
            migration_report
        SET
            update_by=#{updateBy.id},
            update_time=#{updateTime},
            status=-1
        WHERE
            id=#{id}
        ]]>
	</update>

	<sql id="baseColumn">
       SELECT
		t.id,
		t.migration_id,
		t.`type`,
		t.topic_code,
		t.namespace_code,
		t.pg_no,
		t.src_broker_id,
		t.tgt_broker_id,
		t.version,
		`executor`,
		`exception`,
		t.create_time,
		t.create_by,
		t.update_time,
		t.update_by,
		t.status
	</sql>

    <select id="findById" parameterType="long" resultMap="baseResultMap">
        <include refid="baseColumn"/>
		FROM migration_report AS t
        WHERE t.id=#{id}
    </select>

	<select id="findByMigrationId" parameterType="long" resultMap="baseResultMap">
		<include refid="baseColumn"/>
		FROM migration_report AS t
		WHERE t.migration_id=#{migrationId}
	</select>

	<select id="findByStatus" resultMap="baseResultMap">
		<include refid="baseColumn"/>
		FROM migration_report AS t
		WHERE t.`status`=#{status}
	</select>

    <update id="state" parameterType="MigrationReport">
        <![CDATA[
        UPDATE
            migration_report
        SET
           `status`=#{status},
           `update_by`=#{updateBy.id},
           `update_time`=#{updateTime}
        WHERE
            id=#{id}
        ]]>
    </update>

</mapper>